# Plugin Metadata:
# Name: sam-graph-database
# Version: 1.0.0
# Description: A plugin that provides a Graph Database agent to perform complex queries based on natural language.
# Author: SolaceLabs <solacelabs@solace.com>

log:
  stdout_log_level: INFO
  log_file_level: DEBUG
  log_file: __COMPONENT_KEBAB_CASE_NAME__.log


# To use the `shared_config.yaml` file, uncomment the following line and remove the `shared_config` section below.
# !include ../shared_config.yaml
shared_config:
  - broker_connection: &broker_connection
      dev_mode: ${SOLACE_DEV_MODE, false}
      broker_url: ${SOLACE_BROKER_URL, ws://localhost:8008}
      broker_username: ${SOLACE_BROKER_USERNAME, default}
      broker_password: ${SOLACE_BROKER_PASSWORD, default}
      broker_vpn: ${SOLACE_BROKER_VPN, default}
      temporary_queue: ${USE_TEMPORARY_QUEUES, true}

  - models:
    general: &general_model
      # This dictionary structure tells ADK to use the LiteLlm wrapper.
      # 'model' uses the specific model identifier your endpoint expects.
      model: ${LLM_SERVICE_GENERAL_MODEL_NAME} # Use env var for model name
      # 'api_base' tells LiteLLM where to send the request.
      api_base: ${LLM_SERVICE_ENDPOINT} # Use env var for endpoint URL
      # 'api_key' provides authentication.
      api_key: ${LLM_SERVICE_API_KEY} # Use env var for API key

  - services:
    # Default session service configuration
    session_service: &default_session_service
      type: "memory"
      default_behavior: "PERSISTENT"

    # Default artifact service configuration
    artifact_service: &default_artifact_service
      type: "filesystem"
      base_path: "/tmp/samv2"
      artifact_scope: namespace # Or "namespace", "app", "custom"

apps:
  - name: __COMPONENT_KEBAB_CASE_NAME__-app
    app_module: solace_agent_mesh.agent.sac.app
    broker:
      <<: *broker_connection
    app_config:
      namespace: "${NAMESPACE}" # Your A2A topic namespace
      agent_name: "__COMPONENT_PASCAL_CASE_NAME__"
      display_name: "__COMPONENT_SPACED_CAPITALIZED_NAME__ Agent"
      supports_streaming: false # Graph agent tools are typically request-response

      model: *general_model
      instruction: |
        You are __COMPONENT_SPACED_CAPITALIZED_NAME__ agent, an expert Cypher query assistant for the connected graph database.
        The database schema and query examples will be provided to you.
        Your primary goal is to translate user questions into accurate Cypher queries.
        If a user asks to query the database, generate the Cypher and call the 'execute_cypher_query' tool.
        If the 'execute_cypher_query' tool returns an error, analyze the error message and the original Cypher,
        then try to correct the Cypher query and call the tool again.
        If the results are large and the tool indicates they were saved as an artifact, inform the user about the artifact.
        Always use the 'execute_cypher_query' tool to interact with the database.
        Always report the total execution time for queries when providing results to the user.

      # --- Configurable Agent Initialization & Cleanup ---
      agent_init_function:
        module: "sam_graph_database.lifecycle"
        name: "initialize_graph_agent"
        config: # This is the custom_agent_init_config, validated by GraphAgentInitConfigModel
          log_level: "${__COMPONENT_UPPER_SNAKE_CASE_NAME___LOG_LEVEL}"
          db_type: "${__COMPONENT_UPPER_SNAKE_CASE_NAME___DB_TYPE}" # REQUIRED: "neo4j"
          db_host: "${__COMPONENT_UPPER_SNAKE_CASE_NAME___DB_HOST}" # REQUIRED: e.g., "bolt://localhost"
          db_port: ${__COMPONENT_UPPER_SNAKE_CASE_NAME___DB_PORT, 7687} # Optional: e.g., 7687 (default for Neo4j bolt)
          db_user: "${__COMPONENT_UPPER_SNAKE_CASE_NAME___DB_USER}" # REQUIRED: Neo4j username
          db_password: "${__COMPONENT_UPPER_SNAKE_CASE_NAME___DB_PASSWORD}" # REQUIRED: Neo4j password
          db_name: "${__COMPONENT_UPPER_SNAKE_CASE_NAME___DB_NAME}" # REQUIRED: Database name
          query_timeout: 30 # Optional: Default 30 seconds
          database_purpose: "To store connected data and relationships." # Optional: Helps LLM understand context
          data_description: "Contains nodes and relationships representing entities and their connections." # Optional
          auto_detect_schema: true # Optional: Default true. If false, schema_override is required.
          must_rules:
            - "Only use labels, relationships, and properties listed below"
            - "Never invent labels or properties"
            - "Use correct relationship directions"
            - "Use only cypher query syntax Neo4j V5.x will understand"
            - "Ensure queries are syntactically correct"
            - "Optimize queries for performance where possible"
            - "Respond in valid Cypher syntax without additional commentary"
            - "Use DISTINCT, COUNT(DISTINCT x), or collect(DISTINCT x)"
            - "Use COUNT { (pattern) }  instead of size((pattern))"
            - "use COUNT { (pattern) } only if pattern does NOT contain a RETURN"
            - "Any variable referenced after a WITH must be explicitly passed through that WITH"
          must_not_rules:
            - "Use apoc.coll.toSet()"
            - "Use APOC or other procedures not guaranteed to be available"
            - "Make assumptions about data not described in the schema"
            - "Use labels, relationships, or properties not in the schema"
            - "use size((pattern))"
            - "use size() with relationships"
            - "execute write or update statements"
          # Optional: Additional custom rules for the agent to follow
          database_schema_override: "" # Optional: YAML/text string of schema if auto_detect_schema is false.
          schema_summary_override: "" # Optional: Natural language summary if auto_detect_schema is false.
          query_examples: # Optional: List of natural language to Cypher examples
            - natural_language: "Show all nodes of type Person"
              cypher_query: "MATCH (p:Person) RETURN p;"
            - natural_language: "Find all relationships between nodes"
              cypher_query: "MATCH (n)-[r]->(m) RETURN n, r, m LIMIT 100;"
          response_guidelines: "Please note: Data is updated in real-time. Query results reflect the latest state." # Optional

      agent_cleanup_function:
        module: "sam_graph_database.lifecycle"
        name: "cleanup_graph_agent_resources"

      tools:
        - tool_type: builtin-group
          group_name: "artifact_management"
        - tool_type: builtin-group
          group_name: "data_analysis"
        - tool_type: python
          component_module: "sam_graph_database.tools"
          function_name: "execute_cypher_query"

      session_service:
        type: "sql"
        database_url: "${__COMPONENT_UPPER_SNAKE_CASE_NAME___DATABASE_URL, sqlite:///__COMPONENT_SNAKE_CASE_NAME__.db}"
        default_behavior: "PERSISTENT"
      artifact_service: *default_artifact_service

      # Agent Card, Discovery, and Inter-Agent Communication
      agent_card:
        description: "Graph Database Agent that can answer questions by querying a configured Neo4j database."
        defaultInputModes: ["text"]
        defaultOutputModes: ["text", "file"] # Can output text or files (artifacts)
        skills:
          - id: "cypher_query"
            name: "Graph Database Query"
            description: "Answers questions by querying the connected Neo4j graph database using Cypher."

      agent_card_publishing:
        interval_seconds: 30

      agent_discovery:
        enabled: false

      inter_agent_communication:
        allow_list: []
